% !TeX root = ../thesis.tex

\chapter{引言}

传统的 IPC （Inter-Process Communication，进程间通信）机制包括信号、管道、命名管道 、消息队列和共享内存等\cite{modernos}，其性能问题主要体现在以下几个方面：

\begin{itemize}
    \item[1.] 上下文切换开销：进程间通过内核进行通信，保存上下文和切换页表都会带来较大开销，为了解决熔断漏洞时引入的 KPTI 机制进一步增加了陷入内核的开销\cite{kpti}；
    \item[2.] 数据拷贝开销：将数据块从一个进程复制到另一个进程的地址空间中，引入较高的延迟和开销；
    \item[3.] 同步互斥开销：使用锁和信号量等同步机制来保证进程之间访问共享资源的顺序，需要使用原子指令、内存屏障等硬件机制，会引入额外的开销；
    \item[4.] 安全性问题：进程和进程之间、内核和进程之间资源的共享都有可能在产生数据窃取和损坏等问题。
\end{itemize}

在微内核架构中，内核值提供最基本的服务，例如虚拟存储、IPC 等，大部分的系统服务如网络协议栈、文件系统、设备驱动等都以进程的形式运行在用户空间\cite{microkernel}，IPC 因此成为了微内核中最重要的部分之一，同时也是性能瓶颈之一。

用户态中断（User-Interrupt）是由用户接收和响应的中断，相比于传统的 IPC 机制，用户态直接对中断进行处理可以减少陷入内核带来的开销。无论是在宏内核还是微内核中都具有良好的应用场景。用户态中断的发送方可以是下列中的任何一种：

\begin{itemize}
    \item 外部设备：用户态驱动\cite{userdriver}相比于内核的干预更加灵活和轻便，具有良好的可移植性和安全性。引入用户态中断后，用户态驱动可以直接接收并处理外部设备发来的中断，进一步提高性能。
    \item 内核：io\_uring \cite{iouring}是 Linux 5.1 版本引入的一种异步 I/O 机制，支持请求的批量提交、数据零拷贝，已被广泛应用于各种场景。引入用户态中断后，内核在 I/O 操作完成后可以跨核向进程发送用户态中断通知，进一步提高了异步唤醒的效率。
    \item 进程：seL4 的 Notification \cite{sel4}是一种轻量级的 IPC 机制，基于事件队列和快速路径，进程之间可以实现高效的异步通信，但目标进程需要通过轮询或等待的方式来处理信息。引入用户态中断后，目标进程可以在执行其他任务的同时立即接收并处理信息。
\end{itemize}

在前人工作的基础上，笔者设计并验证了 RISC-V 用户态中断扩展，通过 QEMU 模拟器对设计草案进行打磨和完善，并在 Linux 中加入了对 RISC-V 用户态中断扩展的支持；此外，笔者还在 Rocket Chip 中加入了对用户态扩展的支持，通过软件仿真验证实现，并在 zcu102 开发板上进行性能测试，证明了用户态中断无论是在模拟环境下还是在真实的硬件环境下，相比于传统的 IPC 机制可以取得明显的性能提升。

本文主要分为以下几个部分：

\begin{itemize}
    \item \textbf{背景介绍}：简要介绍 RISC-V N 扩展和 x86 用户态中断指令规范；
    \item \textbf{设计草案}： RISC-V 用户态中断扩展设计草案；
    \item \textbf{软件实现}：介绍在 QEMU 、Linux 等系统软件上关于 RISC-V 用户态中断扩展的实现细节；
    \item \textbf{硬件实现}：介绍在 Rocket Chip 上关于 RISC-V 用户态中断扩展的实现细节；
    \item \textbf{性能评估}：分别对软件实现和硬件实现进行性能测试和分析。
\end{itemize}